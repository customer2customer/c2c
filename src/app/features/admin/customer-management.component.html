<section class="panel">
  <div class="loading-overlay" *ngIf="status$ | async as status" [hidden]="status !== 'working'">
    <div class="spinner" aria-label="Loading customers"></div>
  </div>
  <header>
    <h2>Manage customers</h2>
    <p>Create, update or remove customers. Points are used to gate product visibility.</p>
  </header>

  <form [formGroup]="customerForm" (ngSubmit)="createCustomer()" class="grid">
    <label>
      First name
      <input formControlName="firstName" required />
      <small class="error" *ngIf="customerForm.controls['firstName'].invalid && customerForm.controls['firstName'].touched"
        >Required</small
      >
    </label>
    <label>
      Last name
      <input formControlName="lastName" required />
      <small class="error" *ngIf="customerForm.controls['lastName'].invalid && customerForm.controls['lastName'].touched"
        >Required</small
      >
    </label>
    <label>
      Email
      <input formControlName="email" type="email" required />
      <small class="error" *ngIf="customerForm.controls['email'].invalid && customerForm.controls['email'].touched"
        >Enter a valid email</small
      >
    </label>
    <label>
      Phone
      <input formControlName="phone" required />
      <small class="error" *ngIf="customerForm.controls['phone'].invalid && customerForm.controls['phone'].touched"
        >Phone is required</small
      >
    </label>
    <label>
      Address
      <input formControlName="address" required />
      <small class="error" *ngIf="customerForm.controls['address'].invalid && customerForm.controls['address'].touched"
        >Required</small
      >
    </label>
    <label>
      City
      <input formControlName="city" required />
      <small class="error" *ngIf="customerForm.controls['city'].invalid && customerForm.controls['city'].touched"
        >Required</small
      >
    </label>
    <label>
      Password
      <input formControlName="password" type="password" required />
      <small class="error" *ngIf="customerForm.controls['password'].invalid && customerForm.controls['password'].touched"
        >Min 6 characters</small
      >
    </label>
    <label>
      Points
      <input formControlName="points" type="number" min="0" />
    </label>
    <div class="actions">
      <button type="submit">Create customer</button>
      <span class="success" *ngIf="status$ | async as status" [hidden]="status !== 'saved'">Saved</span>
      <span class="error" *ngIf="status$ | async as status2" [hidden]="status2 !== 'error'">Failed</span>
    </div>
  </form>

  <section class="list">
    <header class="list__header">
      <h3>Existing customers</h3>
      <form [formGroup]="pointsForm" (ngSubmit)="updatePoints()" class="inline-form">
        <label>Points<input type="number" formControlName="points" min="0" /></label>
        <label>
          Apply to
          <select formControlName="mode">
            <option value="selected">Selected</option>
            <option value="all">All</option>
          </select>
        </label>
        <button type="submit">Apply points</button>
      </form>
    </header>

    <table>
      <thead>
        <tr>
          <th><input type="checkbox" (change)="toggleSelection('all', $any($event.target).checked)" disabled /></th>
          <th>Name</th>
          <th>Email</th>
          <th>Points</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let customer of customersWithSelection$ | async">
          <td>
            <input
              type="checkbox"
              [checked]="customer.selected"
              (change)="toggleSelection(customer.id, $any($event.target).checked)"
            />
          </td>
          <td>{{ customer.firstName }} {{ customer.lastName }}</td>
          <td>{{ customer.email }}</td>
          <td>{{ customer.points }}</td>
          <td>
            <button type="button" class="danger" (click)="deleteCustomer(customer)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>
</section>
